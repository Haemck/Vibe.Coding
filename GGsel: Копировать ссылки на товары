// ==UserScript==
// @name         GGsel: Копировать ссылки на товары
// @namespace    http://tampermonkey.net/
// @version      1.2
// @description  Кнопка для копирования всех ссылок на товары со страницы поиска ggsel.net
// @author       vibe.coding
// @match        https://ggsel.net/search*
// @grant        GM_setClipboard
// ==/UserScript==

(function() {
    'use strict';

    // --- Стили для кнопки и popup ---
    const style = document.createElement('style');
    style.innerHTML = `
    #copy-products-btn {
        position: fixed;
        right: 32px;
        bottom: 32px;
        z-index: 99999;
        background: #3c3cfc;
        color: #fff;
        padding: 16px 24px;
        border: none;
        border-radius: 18px;
        font-size: 18px;
        cursor: pointer;
        box-shadow: 0 4px 18px #0002;
        opacity: 0.88;
        transition: background .16s, opacity .13s;
    }
    #copy-products-btn:hover {
        background: #5050ff;
        opacity: 1;
    }
    #copy-products-popup {
        position: fixed;
        right: 32px;
        bottom: 90px;
        background: #222;
        color: #fff;
        padding: 12px 22px;
        border-radius: 12px;
        font-size: 17px;
        z-index: 100000;
        opacity: 0.96;
        box-shadow: 0 2px 12px #0004;
        display: none;
        pointer-events: none;
    }`;
    document.head.appendChild(style);

    // --- Кнопка ---
    function addButton() {
        if (document.getElementById('copy-products-btn')) return;
        const btn = document.createElement('button');
        btn.id = 'copy-products-btn';
        btn.textContent = 'Скопировать товары';
        document.body.appendChild(btn);

        btn.addEventListener('click', copyLinks);
    }

    // --- Popup уведомление ---
    function showPopup(msg) {
        let popup = document.getElementById('copy-products-popup');
        if (!popup) {
            popup = document.createElement('div');
            popup.id = 'copy-products-popup';
            document.body.appendChild(popup);
        }
        popup.textContent = msg;
        popup.style.display = 'block';
        setTimeout(() => { popup.style.display = 'none'; }, 1800);
    }

    // --- Основная функция копирования ---
    function copyLinks() {
        // Блок с товарами
        const root = document.querySelector('.ProductContent_productList__xMPhf');
        if (!root) {
            showPopup('Товары не найдены!');
            return;
        }
        // Все карточки товаров
        const cards = root.querySelectorAll('.ProductCard_wrap__ZhIFG a.ProductCard_link__IzjRv');
        const links = [];
        cards.forEach(a => {
            const href = a.getAttribute('href');
            if (href && /^\/catalog\/product\/\d+/.test(href)) {
                links.push(`https://ggsel.net${href}`);
            }
        });

        if (links.length === 0) {
            showPopup('Ссылки не найдены!');
            return;
        }

        const text = links.join('\n');
        if (typeof GM_setClipboard === "function") {
            GM_setClipboard(text);
        } else {
            // fallback
            navigator.clipboard.writeText(text);
        }
        showPopup(`Скопировано: ${links.length} шт.`);
    }

    // --- Добавление кнопки (и повторная попытка если SPA) ---
    function waitForProductsAndAddButton() {
        const check = () => {
            if (document.querySelector('.ProductContent_productList__xMPhf')) {
                addButton();
            } else {
                setTimeout(check, 1000);
            }
        };
        check();
    }

    waitForProductsAndAddButton();

    // Повторно добавлять кнопку после SPA-переходов
    let lastUrl = location.href;
    setInterval(() => {
        if (location.href !== lastUrl) {
            lastUrl = location.href;
            setTimeout(() => {
                waitForProductsAndAddButton();
            }, 900);
        }
    }, 700);

})();
